name: Deploy Frontend to GitHub Pages

on:
  push:
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Wait for `publish-ui` when both frontend and UI package changed
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.sha }}
          BEFORE: ${{ github.event.before }}
        run: |
          set -euo pipefail

          # Determine changed paths between the push range
          git fetch --no-tags --prune --unshallow || true
          CHANGED_FILES=$(git diff --name-only "$BEFORE" "$SHA" || git diff --name-only "$SHA")

          echo "Changed files:"$CHANGED_FILES

          echo "$CHANGED_FILES" | grep -q '^packages/UI/' && UI_CHANGED=true || UI_CHANGED=false
          echo "$CHANGED_FILES" | grep -q '^frontend/' && FE_CHANGED=true || FE_CHANGED=false

          echo "UI_CHANGED=$UI_CHANGED FE_CHANGED=$FE_CHANGED"

          if [ "$UI_CHANGED" = true ] && [ "$FE_CHANGED" = true ]; then
            echo "Both UI package and frontend changed. Waiting for publish-ui workflow to finish for commit $SHA"

            # Poll for a workflow run of publish-ui.yml for this commit
            WORKFLOW_FILE=publish-ui.yml
            ATTEMPTS=0
            MAX_ATTEMPTS=60
            SLEEP_SEC=10

            while [ $ATTEMPTS -lt $MAX_ATTEMPTS ]; do
              ATTEMPTS=$((ATTEMPTS+1))
              echo "Checking workflow runs (attempt $ATTEMPTS)..."
              RESP=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "https://api.github.com/repos/$REPO/actions/workflows/$WORKFLOW_FILE/runs?per_page=50")

              RUN_ID=$(echo "$RESP" | jq -r --arg sha "$SHA" '.workflow_runs[] | select(.head_sha==$sha) | .id' | head -n1 || true)

              if [ -n "$RUN_ID" ] && [ "$RUN_ID" != "null" ]; then
                echo "Found publish-ui run id: $RUN_ID. Polling status..."
                RUN_INFO=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "https://api.github.com/repos/$REPO/actions/runs/$RUN_ID")
                STATUS=$(echo "$RUN_INFO" | jq -r '.status')
                CONCLUSION=$(echo "$RUN_INFO" | jq -r '.conclusion')
                echo "status=$STATUS conclusion=$CONCLUSION"
                if [ "$STATUS" = "completed" ]; then
                  if [ "$CONCLUSION" = "success" ]; then
                    echo "publish-ui completed successfully. Continuing deployment."
                    break
                  else
                    echo "publish-ui finished with conclusion: $CONCLUSION"
                    exit 1
                  fi
                fi
              else
                echo "No matching publish-ui run found yet for this commit."
              fi

              sleep $SLEEP_SEC
            done

            if [ $ATTEMPTS -ge $MAX_ATTEMPTS ]; then
              echo "Timed out waiting for publish-ui workflow to complete."
              exit 1
            fi
          else
            echo "Not both frontend and UI package changed; no need to wait for publish-ui."
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: "https://npm.pkg.github.com/"
          scope: '@francois0203'

      - name: Install dependencies
        run: |
          cd frontend
          npm install
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Build
        run: |
          cd frontend
          npm run build

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './frontend/build'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4