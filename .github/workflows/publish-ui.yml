name: Publish UI Package to GitHub Packages

on:
  push:
    branches: [main]
    paths:
      - 'packages/UI/**'

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Allows committing version bump
      packages: write  # Allows publishing and deleting packages

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          registry-url: "https://npm.pkg.github.com/"
          scope: '@francois0203'
      - name: Install dependencies
        run: |
          cd packages/UI
          npm install

      - name: Auto Bump Version
        run: |
          cd packages/UI
          npm version patch -m "chore: bump version to %s [skip ci]"
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git push --follow-tags

      - name: Build package
        run: |
          cd packages/UI
          npm run build

      - name: Ensure publishable version (auto-bump on conflict)
        id: ensure_version
        run: |
          cd packages/UI
          attempts=0
          max_attempts=5
          while [ $attempts -lt $max_attempts ]; do
            VER=$(node -p "require('./package.json').version")
            echo "Checking registry for version $VER"
            if npm --registry https://npm.pkg.github.com view @francois0203/ui@$VER >/dev/null 2>&1; then
              echo "Version $VER already exists, bumping patch"
              npm version patch -m "chore: bump version to %s [skip ci]"
              git config --global user.name "github-actions"
              git config --global user.email "github-actions@github.com"
              git push --follow-tags
              attempts=$((attempts+1))
              sleep 1
            else
              echo "published=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          done
          echo "Max attempts ($max_attempts) reached and version still exists" >&2
          echo "published=true" >> $GITHUB_OUTPUT
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to GitHub Packages
        if: steps.ensure_version.outputs.published == 'false'
        run: |
          cd packages/UI
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Skip publish - no available version
        if: steps.ensure_version.outputs.published == 'true'
        run: |
          echo "No available version to publish after $max_attempts attempts; skipping npm publish."

      - name: Delete Old Versions (Keep Latest 2)
        run: |
          GH_TOKEN=${{ secrets.GITHUB_TOKEN }}
          OWNER=Francois0203
          PACKAGE_NAME=ui
          PACKAGE_TYPE=npm

          # Get package versions sorted by creation date (latest first)
          versions=$(curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/users/$OWNER/packages/$PACKAGE_TYPE/$PACKAGE_NAME/versions" | jq 'sort_by(.created_at) | reverse | .[].id')

          # Delete all except the latest 2 versions
          echo "$versions" | tail -n +3 | while read -r version; do
            echo "Deleting version: $version"
            curl -X DELETE -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/users/$OWNER/packages/$PACKAGE_TYPE/$PACKAGE_NAME/versions/$version"
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}