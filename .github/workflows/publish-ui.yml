name: Publish UI Package to GitHub Packages

on:
  push:
    branches: [main]
    paths:
      - 'packages/UI/**'
      - '.github/workflows/publish-ui.yml'

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Allows committing version bump
      packages: write  # Allows publishing and deleting packages

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          registry-url: "https://npm.pkg.github.com/"
          scope: '@francois0203'
      - name: Install dependencies
        run: |
          cd packages/UI
          npm install

      - name: Auto Bump Version
        run: |
          cd packages/UI
          npm version patch -m "chore: bump version to %s [skip ci]"
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git commit -am "chore: bump version"
          git push

      - name: Build package
        run: |
          cd packages/UI
          npm run build

      - name: Publish to GitHub Packages
        run: |
          cd packages/UI
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger frontend workflow if frontend changed
        if: always()
        run: |
          # Ensure we have history to compute changed files
          git fetch --no-tags --prune --unshallow || true

          echo "Changed files between ${{ github.event.before }} and ${{ github.sha }}:"
          git diff --name-only ${{ github.event.before }} ${{ github.sha }} || true

          if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -qE '^frontend/'; then
            echo "Frontend changes detected â€” triggering frontend workflow via repository dispatch."
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github+json" \
              https://api.github.com/repos/${{ github.repository }}/dispatches \
              -d '{"event_type":"trigger-frontend-after-ui"}'
          else
            echo "No frontend changes detected; not triggering frontend workflow."
          fi

      - name: Delete Old Versions (Keep Latest 2)
        run: |
          GH_TOKEN=${{ secrets.GITHUB_TOKEN }}
          OWNER=Francois0203
          PACKAGE_NAME=ui
          PACKAGE_TYPE=npm

          # Get package versions sorted by creation date (latest first)
          versions=$(curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/users/$OWNER/packages/$PACKAGE_TYPE/$PACKAGE_NAME/versions" | jq 'sort_by(.created_at) | reverse | .[].id')

          # Delete all except the latest 2 versions
          echo "$versions" | tail -n +3 | while read -r version; do
            echo "Deleting version: $version"
            curl -X DELETE -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/users/$OWNER/packages/$PACKAGE_TYPE/$PACKAGE_NAME/versions/$version"
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}